<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Messages - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.0.2/firebase-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.0.2/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.0.2/firebase-functions.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.0.2/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container mt-5">
    <h2 class="text-center mb-4">Contact Messages</h2>

    <!-- Filter Options -->
    <div class="mb-4">
        <label for="filterStatus" class="form-label">Filter Messages</label>
        <select id="filterStatus" class="form-select" onchange="filterMessages()">
            <option value="all">All Messages</option>
            <option value="unread">Unread</option>
            <option value="read">Read</option>
            <option value="archived">Archived</option>
        </select>
    </div>

    <!-- Messages Table -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Name</th>
                <th scope="col">Email</th>
                <th scope="col">Message</th>
                <th scope="col">Status</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody id="messagesList">
            <!-- Messages will be dynamically loaded here -->
        </tbody>
    </table>
</div>

<!-- Message Detail Modal -->
<div class="modal fade" id="messageDetailModal" tabindex="-1" aria-labelledby="messageDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageDetailModalLabel">Message Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="messageDetailsContent">
                    <!-- Message content will be dynamically loaded here -->
                </div>
                <textarea id="replyMessage" class="form-control" rows="4" placeholder="Write your reply..."></textarea>
                <button class="btn btn-primary mt-3" onclick="sendReply()">Send Reply</button>
                <button class="btn btn-danger mt-3" onclick="archiveMessage()">Archive Message</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Firebase configuration and initialization
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Fetch messages from Firestore
    async function fetchMessages(status = 'all') {
        let query = db.collection('contactMessages');

        if (status !== 'all') {
            query = query.where('status', '==', status);
        }

        const snapshot = await query.get();
        const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        displayMessages(messages);
    }

    // Display messages in the table
    function displayMessages(messages) {
        const messagesList = document.getElementById('messagesList');
        messagesList.innerHTML = '';

        messages.forEach((message, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${message.name}</td>
                <td>${message.email}</td>
                <td>${message.message.slice(0, 50)}...</td>
                <td>
                    <span class="badge ${message.status === 'unread' ? 'bg-warning' : message.status === 'read' ? 'bg-success' : 'bg-secondary'}">
                        ${message.status.charAt(0).toUpperCase() + message.status.slice(1)}
                    </span>
                </td>
                <td>
                    <button class="btn btn-info" onclick="viewMessageDetails('${message.id}')">View</button>
                    <button class="btn btn-secondary" onclick="toggleReadStatus('${message.id}', '${message.status}')">${message.status === 'read' ? 'Mark as Unread' : 'Mark as Read'}</button>
                    <button class="btn btn-danger" onclick="archiveMessage('${message.id}')">Archive</button>
                </td>
            `;
            messagesList.appendChild(row);
        });
    }

    // View full message details in a modal
    async function viewMessageDetails(messageId) {
        const messageDoc = await db.collection('contactMessages').doc(messageId).get();
        const message = messageDoc.data();
        
        document.getElementById('messageDetailModalLabel').innerText = `Message from ${message.name}`;
        document.getElementById('messageDetailsContent').innerText = message.message;
        
        $('#messageDetailModal').modal('show');
    }

    // Mark message as read/unread
    async function toggleReadStatus(messageId, currentStatus) {
        const newStatus = currentStatus === 'read' ? 'unread' : 'read';
        await db.collection('contactMessages').doc(messageId).update({ status: newStatus });

        fetchMessages();
    }

    // Archive a message
    async function archiveMessage(messageId) {
        await db.collection('contactMessages').doc(messageId).update({ status: 'archived' });
        fetchMessages();
    }

    // Reply to a message (send an email notification and reply in the database)
    async function sendReply() {
        const replyContent = document.getElementById('replyMessage').value;
        const messageId = document.getElementById('messageDetailModalLabel').innerText.split(' ')[2];  // Extract messageId from modal title

        // Send the reply in Firestore
        await db.collection('contactMessages').doc(messageId).update({
            reply: replyContent,
            status: 'read' // mark as read once replied
        });

        // Trigger email notification (e.g., using Firebase Functions or a third-party service)
        await sendEmailNotification(replyContent);

        // Close modal and refresh the message list
        $('#messageDetailModal').modal('hide');
        fetchMessages();
    }

    // Send an email notification (simplified example)
    async function sendEmailNotification(replyContent) {
        const emailPayload = {
            to: "photographer@example.com", // Use the sender's email address dynamically
            subject: "New Contact Message Reply",
            body: `You have received a new reply: \n\n${replyContent}`
        };

        // Call Firebase Cloud Functions to send an email (this is a placeholder function)
        const sendEmail = firebase.functions().httpsCallable('sendEmail');
        await sendEmail(emailPayload);
    }

    // Filter messages by status (unread, read, archived)
    function filterMessages() {
        const status = document.getElementById('filterStatus').value;
        fetchMessages(status);
    }

    // Initial load of all messages
    fetchMessages();
</script>

<!-- Bootstrap JS for modal functionality -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
