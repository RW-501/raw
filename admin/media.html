<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event & Photo Management</title>
    <!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">


<link rel="stylesheet" href="../css/admin.css">

<style>

    /* Modal styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    width: 300px;
    text-align: center;
}

button {
    margin: 10px;
    padding: 10px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

button:hover {
    background-color: #45a049;
}

</style>
</head>
<body>


<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <a class="navbar-brand" href="https://shutterworx.co/">ShutterWorx Admin</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="../index">Your Site</a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="../admin/index">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/media">Media</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/contact">Contact</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/design">Design</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/analytics">Analytics</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/transactions">Transactions</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/settings">Settings</a>
            </li>
        </ul>
    </div>
</nav>


<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="../admin/">Home</a></li>
      <li class="breadcrumb-item active" aria-current="page">Media</li>
    </ol>
  </nav>
  


  <main id="main-content">


        <h2 class="text-center mb-4">Event & Photo Management</h2>
    
        <!-- Admin Messages Section -->
        <section>
            <div id="admin-messages" class="admin-messages-container">
                <p id="message-text" class="fade-in"></p>
                <div id="message-actions" class="message-actions"></div>
            </div>
        </section>
    
<!-- Add to Gallery Button 
<button onclick="openAddToGalleryModal()">Add to Gallery</button>
-->

<!-- Toggle Bar -->
<div class="mediaTabs">
    <button class="tabButton" onclick="showTabContent('Add_Event')">Add Event</button>
    <button class="tabButton" onclick="showTabContent('Add_Media')">Add Media</button>
    <button class="tabButton" onclick="showTabContent('Manage_Events')">Manage Events</button>
    <button class="tabButton" onclick="showTabContent('Manage_Gallery')">Manage Gallery</button>
</div>


<div id="Add_Event" class="media_tabs">

        <!-- Event Upload Form -->
        <div class="card mb-4 shadow-lg">
            <div class="card-body">
                <h5 class="card-title">Upload New Event</h5>
                <form id="eventForm">
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Event Title</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="eventDate" class="form-label">Event Date</label>
                        <input type="date" class="form-control" id="eventDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventCover" class="form-label">Cover Photo</label>
                        <input type="file" class="form-control" id="eventCover" accept="image/*" required>
                    </div>
                    <div class="mb-3">
                        <label for="accessCode" class="form-label">Access Code (if private)</label>
                        <input type="text" class="form-control" id="accessCode" placeholder="Optional">
                    </div> 
                    <button id="uploadEvent" type="button" class="btn btn-primary" >Upload Event</button>
                    <button id="saveEvent" type="button" class="btn btn-primary" >Save Event</button>
                </form>
            </div>
        </div>


    </div>
    <div id="Add_Media" class="media_tabs">
        <div class="card mb-4 shadow-lg">
            <div class="card-body">
                <h5 class="card-title">Upload Photos for Events</h5>
                <input type="file" id="photoUpload" class="form-control" multiple accept="image/*">
                <div class="mt-3">
                    <label for="watermarkText" class="form-label">Watermark Text</label>
                    <input type="text" class="form-control" id="watermarkText" placeholder="Enter watermark text">
                </div>
                <div class="mt-3">
                    <label for="watermarkPosition" class="form-label">Watermark Position</label>
                    <select class="form-control" id="watermarkPosition">
                        <option value="center">Centered</option>
                        <option value="diagonal">Diagonal</option>
                    </select>
                </div>
                <div class="mt-3">
                    <label for="watermarkOpacity" class="form-label">Watermark Opacity</label>
                    <input type="range" class="form-control" id="watermarkOpacity" min="0" max="1" step="0.1" value="0.5">
                </div>
                <div class="mt-3">
                    <label for="logoOverlay" class="form-label">Logo Overlay (Optional)</label>
                    <input type="file" class="form-control" id="logoOverlay" accept="image/*">
                </div>
                <div class="mt-3">
                    <label for="logoScale" class="form-label">Logo Scale (Resize)</label>
                    <input type="range" class="form-control" id="logoScale" min="0.1" max="1" step="0.1" value="0.5">
                </div>
                <div class="mt-3">
                    <label for="photoPrice" class="form-label">Photo Price</label>
                    <input type="number" class="form-control" id="photoPrice" placeholder="Set price for this photo (optional)">
                </div>
                <div class="mt-3">
                    <label for="photoPublic" class="form-label">Make Photo Public</label>
                    <input type="checkbox" id="photoPublic" class="form-check-input">
                </div>
                <div class="mt-3">
                    <label for="collectionPrice" class="form-label">Collection Price</label>
                    <input type="number" class="form-control" id="collectionPrice" placeholder="Set price for the entire collection (optional)">
                </div>
                <button id="bulkUploadPhotos" type="button" class="btn btn-primary mt-3">Upload Photos with Watermark</button>
    
                <!-- Preview Area -->
                <div class="mt-4">
                    <h5>Preview:</h5>
                    <canvas id="watermarkPreview" style="max-width: 100%; height: auto;"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div id="Manage_Events" class="media_tabs">
    
        <div  class="card mb-4 shadow-lg">
      <!-- Event Sorting and Filtering Section onchange="fetchEvents()"-->
      <div class="mb-4 card-body">
        <h5 class="mb-3">Sort & Filter Events</h5>
        <div class="form-inline">
            <input type="text" class="form-control mb-2 mr-2" id="eventFilter" placeholder="Search by name or description" onkeyup="fetchEvents()">
            <select  class="form-control mb-2" id="sortBy" >
                <option value="eventDate">Sort by Date</option>
                <option value="title">Sort by Name</option>
            </select>
        </div>
    </div>
</div>

    <!-- Event List with Edit & Delete Options -->
    <div  class="card mb-4 shadow-lg">

        <div id="eventList" class="mb-4 card-body">
            <h5 class="mb-3">Manage Events</h5>
            <div class="list-group" id="eventsContainer"></div>
        </div>
        <div id="eventMediaContainer">
            <div id="eventDetails">
                <!-- Event-level metadata will be dynamically added here -->
            </div>
            <div id="mediaList">
                <!-- Media items will be dynamically listed here -->
            </div>
        </div>
        
    </div>
</div>

                <!-- Media Gallery Section -->

    <div id="Manage_Gallery" class="media_tabs">
        <div class="card mb-4 shadow-lg">
<div id="mainGallerySection" class="card-body">
    <h5 class="mb-3">Manage Gallery</h5>

    <div id="galleryContainer"></div>
</div>

    
</div>

 </div>

  </main>


  <div id="currentEventID" ></div>

 <!-- Add to Gallery Modal -->
 <div id="addToGalleryModal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>Add Media to Gallery</h3>
        <p>Select a category:</p>
        <button onclick="addMediaToGallery('portrait')">Portrait</button>
        <button onclick="addMediaToGallery('event')">Event</button>
        <button onclick="addMediaToGallery('commercial')">Commercial</button>
        <button onclick="addMediaToGallery('family')">Family</button>
        <button onclick="addMediaToGallery('other')">Other</button>
        <button onclick="closeModal()">Cancel</button>
    </div>
</div>


  <!-- Footer style="display: none;" -->
<footer class="bg-dark text-light py-3">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <p>&copy; 2024 <a href="https://ShutterWorx.co" class="text-light">ShutterWorx</a> All rights reserved.</p>
            </div>
            <div class="col-md-6 text-md-right">
                <ul class="list-inline">
                    <li class="list-inline-item"><a href="https://ShutterWorx.co/FAQ" class="text-light">FAQs</a></li>
                    <li class="list-inline-item"><a href="https://ShutterWorx.co/join" class="text-light">Upgrade</a></li>
                    <li class="list-inline-item"><a href="https://ShutterWorx.co/contact" class="text-light">Contact Us</a></li>
                    <li class="list-inline-item"><a href="https://ShutterWorx.co/privacy" class="text-light">Privacy Policy</a></li>
                    <li class="list-inline-item"><a href="https://ShutterWorx.co/terms" class="text-light">Terms of Service</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>

<script src="../js/admin.js" ></script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>


<!-- Firebase JS SDK and Custom Scripts -->

<script type="module">
    import { db, doc, getDoc, query, updateDoc, 
            setDoc, ref, signInWithPopup, orderBy,
            GoogleAuthProvider, FacebookAuthProvider, 
            uploadBytes, OAuthProvider, arrayUnion, 
            signOut, addDoc, increment, onAuthStateChanged, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword, 
            where, getDocs, storage, collection, 
            auth, analytics, deleteDoc, getDownloadURL } from '../js/module.js';

    // Bulk Upload Photos Function
    async function bulkUploadPhotos(eventId) {
    const watermarkText = sanitizeInput(document.getElementById('watermarkText').value);
    const watermarkPosition = document.getElementById('watermarkPosition').value;
    const watermarkOpacity = document.getElementById('watermarkOpacity').value;
    const logoOverlay = document.getElementById('logoOverlay').files[0];
    const logoScale = document.getElementById('logoScale').value;
    const photos = document.getElementById('photoUpload').files;
    const photoPrice = document.getElementById('photoPrice').value;
    const collectionPrice = document.getElementById('collectionPrice').value;
    const isPublic = document.getElementById('photoPublic').checked;

    // Check if photos are uploaded
    if (photos.length === 0) {
        showToast("Please select at least one photo.", "error");
        return;
    }

    // Validate files and provide suggestions
    const MAX_FILE_SIZE_MB = 5; // Max file size (in MB)
    const VALID_FILE_TYPES = ["image/jpeg", "image/png", "image/webp", "image/bmp", "image/gif", "image/tiff", "image/svg+xml"]; // Allowed file types
    const invalidFiles = [];
    const uploadedFiles = [];

    for (const photo of photos) {
        const fileSizeMB = photo.size / (1024 * 1024); // Convert size to MB
        const fileType = photo.type;

        // Validate file type
        if (!VALID_FILE_TYPES.includes(fileType)) {
            invalidFiles.push(`${photo.name} (Invalid type: ${fileType})`);
            continue;
        }

        // Validate file size
        if (fileSizeMB > MAX_FILE_SIZE_MB) {
            invalidFiles.push(`${photo.name} (Too large: ${fileSizeMB.toFixed(2)} MB)`);
            continue;
        }

        const photoRef = ref(storage, `eventPhotos/${eventId}/${cleanAndShortenFileName(photo.name)}`);
        try {
            // Upload photo to Firebase storage
            await uploadBytes(photoRef, photo);
            const photoUrl = await getDownloadURL(photoRef);

            // Process watermarking
            let watermarkedImageUrl = await applyWatermark(photoUrl, watermarkText, watermarkPosition, watermarkOpacity, logoOverlay, logoScale);

            // Save photo details
            await savePhotoDetails(photoUrl, photoPrice, collectionPrice, isPublic, eventId, watermarkedImageUrl, fileSizeMB, fileType);
            uploadedFiles.push(photo.name);

        } catch (error) {
            console.error("Error uploading photo:", error);
            showToast(`An error occurred while uploading the photo: ${photo.name}`, "error");
        }
    }

    // Show upload results
    if (invalidFiles.length > 0) {
        showToast(`The following files could not be uploaded:\n${invalidFiles.join("\n")}`, "warning");
    }

    if (uploadedFiles.length > 0) {
        showToast(`Successfully uploaded: ${uploadedFiles.join(", ")}`, "success");
    }
}

// Updated savePhotoDetails to include fileType and fileSize
async function savePhotoDetails(photoUrl, photoPrice, collectionPrice, isPublic, eventId, watermarkedImageUrl, fileSize, fileType) {
    const photoDetails = {
        photoUrl,
        watermarkedImageUrl,
        eventId,
        price: photoPrice,
        collectionPrice,
        isPublic,
        timestamp: new Date(),
        fileSize: fileSize.toFixed(2), // Save as MB with 2 decimal points
        fileType,
        status: "active",
        views: 0,
        deactived: false,
    };

    try {
        const docRef = await addDoc(collection(db, "Media"), photoDetails);
        console.log("Document written with ID: ", docRef.id);
    } catch (error) {
        console.error("Error adding document: ", error);
        showToast("Error saving photo details to the database.", "error");
    }
}


document.getElementById('photoUpload').addEventListener('change', handleFileUpload);
document.getElementById('watermarkText').addEventListener('input', updatePreview);
document.getElementById('watermarkPosition').addEventListener('change', updatePreview);
document.getElementById('watermarkOpacity').addEventListener('input', updatePreview);
document.getElementById('logoOverlay').addEventListener('change', updatePreview);
document.getElementById('logoScale').addEventListener('input', updatePreview);

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageUrl = e.target.result;
            updatePreview(imageUrl); // Initial preview when file is selected
        };
        reader.readAsDataURL(file);
    }
}

async function updatePreview(imageUrl) {
    const text = document.getElementById('watermarkText').value;
    const position = document.getElementById('watermarkPosition').value;
    const opacity = parseFloat(document.getElementById('watermarkOpacity').value);
    const logoFile = document.getElementById('logoOverlay').files[0];
    const scale = parseFloat(document.getElementById('logoScale').value);

    const previewCanvas = document.getElementById('watermarkPreview');
    const previewCtx = previewCanvas.getContext('2d');

    const img = new Image();
    img.src = imageUrl;

    img.onload = async function() {
        // Set canvas size to match image size
        previewCanvas.width = img.width;
        previewCanvas.height = img.height;

        previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height); // Clear previous preview
        previewCtx.drawImage(img, 0, 0);

        // Apply watermark with live updates
        const watermarkedImage = await applyWatermark(img.src, text, position, opacity, logoFile, scale);
        const watermarkedImg = new Image();
        watermarkedImg.src = watermarkedImage;
        watermarkedImg.onload = function() {
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height); // Clear the canvas
            previewCtx.drawImage(watermarkedImg, 0, 0); // Draw the watermarked image
        };
    };
}

async function applyWatermark(imageUrl, text, position, opacity, logo, scale) {
    const img = new Image();
    img.src = imageUrl;

    await new Promise((resolve) => {
        img.onload = resolve;
    });

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    canvas.width = img.width;
    canvas.height = img.height;

    ctx.drawImage(img, 0, 0);

    // Apply text watermark
    if (text) {
        ctx.font = "30px Arial";
        ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
        if (position === "center") {
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, img.width / 2, img.height / 2);
        } else if (position === "diagonal") {
            ctx.save();
            ctx.translate(img.width / 2, img.height / 2);
            ctx.rotate(Math.PI / 4); // 45 degrees
            ctx.fillText(text, 0, 0);
            ctx.restore();
        }
    }

    // Apply logo watermark (if any)
    if (logo) {
        const logoImg = new Image();
        logoImg.src = URL.createObjectURL(logo);
        await new Promise((resolve) => {
            logoImg.onload = resolve;
        });

        const logoWidth = logoImg.width * scale;
        const logoHeight = logoImg.height * scale;
        const x = img.width - logoWidth - 10;
        const y = img.height - logoHeight - 10;

        ctx.drawImage(logoImg, x, y, logoWidth, logoHeight);
    }

    return canvas.toDataURL();
}
  // Upload Event Function
  async function uploadEvent() {
        const title = document.getElementById('eventTitle').value;
        const description = document.getElementById('eventDescription').value;
        const eventDate = document.getElementById('eventDate').value;
        const cover = document.getElementById('eventCover').files[0];
        const accessCode = document.getElementById('accessCode').value;

        // Client-side validation
        if (!title || !description || !eventDate || !cover) {
            alert("Please fill in all fields.");
            return;
        }

        if (cover.size > 5000000) {
            alert("File size is too large. Please upload a file less than 5MB.");
            return;
        }

        const storageRef = ref(storage, `events/${title}/cover.jpg`);
        try {
            // Upload cover image to Firebase storage
            await uploadBytes(storageRef, cover);
            const coverUrl = await getDownloadURL(storageRef);

            // Hash the access code (for demo, using btoa)
           // const hashedAccessCode = btoa(accessCode);

            // Add event to Firestore
            await addDoc(collection(db, 'Events'), {
                title,
                description,
                eventDate,
                coverUrl,
                retrieveCount: 0,
                retriever_IP: [],
                accessHandShake: accessHandShake,
        status: "active",
        isPublic: true,
        collection_price: "",
        collection_OnSellPrice: "",
        eventTags: [],
        accessCode: accessCode || "",
        location: location || "",
        timestamp: new Date(),
        comments: [],
        views: 0,
        deactived: false,
        galleryBool: true
                });

            showToast('Event uploaded successfully');
            document.getElementById('eventForm').reset();
            fetchEvents(); // Refresh event list
        } catch (error) {
            console.error("Error uploading event:", error);
            alert("An error occurred while uploading the event.");
        }
    }


    // Fetch and display events with sorting and filtering
    async function fetchEvents() {
    const filterText = document.getElementById('eventFilter').value.toLowerCase();
    const sortBy = document.getElementById('sortBy').value;
    const eventList = document.getElementById('eventsContainer');
    eventList.innerHTML = ''; // Clear previous list

    const eventsCollection = collection(db, 'Events');
    let eventQuery;

    // Sort events
    if (sortBy === 'date') {
        eventQuery = query(eventsCollection, orderBy('eventDate'));
    } else {
        eventQuery = query(eventsCollection, orderBy('title'));
    }

    try {
        const snapshot = await getDocs(eventQuery);

      snapshot.forEach((doc) => {
    const event = doc.data();

    // Fallbacks for missing or null event properties
    const title = event.title || 'Untitled Event';
    const description = event.description || 'No description available';
    const eventDate = event.eventDate ? new Date(event.eventDate).toLocaleDateString() : 'Date not available';
    const coverUrl = event.coverUrl || 'default-thumbnail.png'; // Default if coverUrl is missing
    const retrieveCount = event.retrieveCount || 0;
    const status = event.status || true;
    const isPublic = event.isPublic || false;
    const collectionPrice = event.collection_price || 'Not set';
    const eventTags = event.eventTags || 'No tags';
    const location = event.location || 'Location not provided';
    const timestamp = event.timestamp ? new Date(event.timestamp.seconds * 1000).toLocaleString() : 'Timestamp not available';
    const comments = event.comments || 'No comments';
    const views = event.views || 0;
    const galleryBool = event.galleryBool ? 'Enabled' : 'Disabled';

    // Filter matching events
    if (
        title.toLowerCase().includes(filterText) ||
        description.toLowerCase().includes(filterText)
    ) {
        const eventItem = document.createElement('div');
        eventItem.classList.add('list-group-item', 'd-flex', 'flex-column', 'align-items-start', 'mb-3', 'p-3');
        eventItem.style.border = '1px solid #ddd';
        eventItem.style.borderRadius = '8px';
        eventItem.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';

        // Collapsible content
        const detailsId = `details-${doc.id}`;
        eventItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <img src="${coverUrl}" alt="Event Thumbnail" style="width: 60px; height: 60px; margin-right: 15px; border-radius: 4px;" />
                    <div>
                        <strong>${title}</strong>
                        <p style="margin: 0; font-size: 0.9rem; color: #666;">${eventDate}</p>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary btn-sm" onclick="viewMedia('${doc.id}', '${title}', '${eventDate}', ${isPublic}, '${coverUrl}')">View Media</button>
                    <button class="btn btn-warning btn-sm" onclick="editEvent('${doc.id}', ${event})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteEvent('${doc.id}')">Delete</button>
                    <button class="btn btn-primary btn-sm" onclick="addMedia('${doc.id}')">Add Media</button>
                </div>
            </div>
            <button class="btn btn-link mt-2 text-decoration-none" style="font-size: 0.9rem;" onclick="toggleDetails('${detailsId}')">
                ${isPublic ? "Hide" : "Show"} Details
            </button>
            <div id="${detailsId}" class="collapse mt-3">
                <p><strong>Description:</strong> ${description}</p>
                <p><strong>Status:</strong> <span class="badge ${status ? 'bg-success' : 'bg-danger'}">
                    ${status ? "Yes" : "No"}
                </span></p>
                <p><strong>Tags:</strong> ${eventTags}</p>
                <p><strong>Location:</strong> ${location}</p>
                <p><strong>Collection Price:</strong> $${collectionPrice}</p>
                <p><strong>Views:</strong> ${views}</p>
                <p><strong>Retrieve Count:</strong> ${retrieveCount}</p>
                <p><strong>Timestamp:</strong> ${timestamp}</p>
                <p><strong>Gallery Enabled:</strong> ${galleryBool}</p>
                <p><strong>Comments:</strong> ${comments}</p>
                <button class="btn btn-secondary btn-sm" onclick="viewAnalytics('${doc.id}')">View Analytics</button>
            </div>
        `;

        eventList.appendChild(eventItem);

}
});
} catch (error) {
console.error("Error fetching events:", error);
}
}


// Function to toggle collapsible details
function toggleDetails(detailsId) {
    const details = document.getElementById(detailsId);
    details.classList.toggle('collapse');
}

// Function to handle analytics view
function viewAnalytics(eventId) {
    alert(`Viewing analytics for event ID: ${eventId}`);
    
    // Navigate to the analytics page, passing the event ID as a URL parameter
    window.location.href = `../admin/analytics?eventId=${eventId}`;
}


        






let eventInfo = '';

async function viewMedia(eventId, eventTitle, eventDate, publicStatus, coverPhoto) {
    const mediaCollectionRef = collection(db, "Media");
    const mediaQuery = query(mediaCollectionRef, where("eventId", "==", eventId));
    const mediaSnapshot = await getDocs(mediaQuery);

    const mediaListContainer = document.getElementById("mediaList");
    const eventDetailsContainer = document.getElementById("eventDetails");

    // Reset containers
    mediaListContainer.innerHTML = "";
    eventDetailsContainer.innerHTML = "";

    let imageCount = 0;
     eventInfo = [eventId, eventTitle, eventDate, publicStatus, coverPhoto];
     const mediaItems = [];

    mediaSnapshot.forEach((doc) => {
        const data = doc.data();
        imageCount++;
        mediaItems.push({ id: doc.id, ...data });

        // Use the first image as the cover photo
        if (!coverPhoto) coverPhoto = data.photoUrl;
    });

    // Event-level metadata
    eventDetailsContainer.innerHTML = `
        <h3>${eventTitle}</h3>
        <p>Date: ${eventDate}</p>
        <p>Public: ${publicStatus ? "Yes" : "No"}</p>
        <img src="${coverPhoto}" alt="Event Cover Photo" class="event-cover">
        <p>Total Images: ${imageCount}</p>
        <div class="batch-buttons">
            <button onclick="batchSetPublic('${eventId}', true)">Set All Public</button>
            <button onclick="batchSetPublic('${eventId}', false)">Set All Private</button>
            <button onclick="batchUpdatePrices('${eventId}')">Update All Prices</button>
        </div>
    `;

    // Generate media items
    mediaItems.forEach((item) => {
        const mediaDiv = document.createElement("div");
        mediaDiv.classList.add("media-item");
        mediaDiv.innerHTML = `
            <div class="media-header">
                <img 
                    data-src="${item.photoUrl}" 
                    alt="Media" 
                    class="media-thumbnail lazy"
                >
                <p>Price: $${item.price}</p>
                <p>Collection Price: $${item.collectionPrice}</p>
                <button onclick="togglePublicStatus('${item.id}', ${!item.isPublic})">
                    ${item.isPublic ? "Make Private" : "Make Public"}
                </button>
                <button onclick="updatePrice('${item.id}')">Update Price</button>
                <button onclick="toggleDetails('${item.id}')">View Details</button>
            </div>
            <div id="details-${item.id}" class="media-details collapse">
                <p>File Type: ${item.fileType}</p>
                <p>File Size: ${item.fileSize} MB</p>
                <p>Status: ${item.status}</p>
                <p>Views: ${item.views}</p>
                <p>Timestamp: ${new Date(item.timestamp.seconds * 1000).toLocaleString()}</p>
            </div>
        `;
        mediaListContainer.appendChild(mediaDiv);
    });

    // Initialize lazy loading
    initializeLazyLoading();
}

// Lazy loading implementation
function initializeLazyLoading() {
    const lazyImages = document.querySelectorAll(".lazy");
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove("lazy");
                observer.unobserve(img);
            }
        });
    });

    lazyImages.forEach((img) => observer.observe(img));
}

// Batch set public/private
async function batchSetPublic(eventId, isPublic) {
    const mediaCollectionRef = collection(db, "Media");
    const mediaQuery = query(mediaCollectionRef, where("eventId", "==", eventId));
    const mediaSnapshot = await getDocs(mediaQuery);

    const batch = writeBatch(db);
    mediaSnapshot.forEach((doc) => {
        batch.update(doc.ref, { isPublic });
    });

    await batch.commit();
    alert(`All media set to ${isPublic ? "Public" : "Private"}.`);
    viewMedia(eventInfo); // Refresh the view
}

// Batch update prices
async function batchUpdatePrices(eventId) {
    const newPrice = prompt("Enter the new price for all media:");
    if (!newPrice || isNaN(newPrice)) {
        alert("Invalid price.");
        return;
    }

    const mediaCollectionRef = collection(db, "Media");
    const mediaQuery = query(mediaCollectionRef, where("eventId", "==", eventId));
    const mediaSnapshot = await getDocs(mediaQuery);

    const batch = writeBatch(db);
    mediaSnapshot.forEach((doc) => {
        batch.update(doc.ref, { price: parseFloat(newPrice) });
    });

    await batch.commit();
    alert("Prices updated successfully.");
    viewMedia(eventInfo); // Refresh the view
}

// Function to toggle the public status
async function togglePublicStatus(docId, newStatus) {
    const docRef = doc(db, "Media", docId);
    await updateDoc(docRef, { isPublic: newStatus });
    alert(`Photo is now ${newStatus ? "Public" : "Private"}`);
    viewMedia(eventInfo); // Refresh the list
}

// Function to update the price
async function updatePrice(docId) {
    const newPrice = prompt("Enter the new price:");
    if (!newPrice || isNaN(newPrice)) {
        alert("Invalid price.");
        return;
    }
    const docRef = doc(db, "Media", docId);
    await updateDoc(docRef, { price: parseFloat(newPrice) });
    alert("Price updated successfully.");
    viewMedia(eventInfo); // Refresh the list
}










    // Edit Event Function
    function editEvent(eventId, event) {
        let Event = JSON.stringify(event);
console.log("event: ",Event);

        document.getElementById('eventTitle').value = event.title;
        document.getElementById('eventDescription').value = event.description;
        document.getElementById('eventDate').value = event.eventDate;
        document.getElementById('accessCode').value = event.accessCode;
        document.getElementById('uploadEvent').disabled;
        document.getElementById('currentEventID').innerText = eventId;
    }

// Save Event Function
async function saveEvent() {
    const eventId = document.getElementById('currentEventID').innerText.trim();
    if (!eventId) {
        console.error("No current event ID found.");
        showToast("Error: No event selected to save.", "error");
        return;
    }

    // Get updated event details from the form fields
    const updatedEvent = {
        title: document.getElementById('eventTitle').value.trim(),
        description: document.getElementById('eventDescription').value.trim(),
        eventDate: document.getElementById('eventDate').value.trim(),
        accessCode: document.getElementById('accessCode').value.trim(),
    };

    // Validate input
    if (!updatedEvent.title || !updatedEvent.eventDate) {
        showToast("Please fill out the required fields.", "warning");
        return;
    }

    try {
        // Update the event in Firestore
        const eventRef = doc(db, 'Events', eventId);
        await updateDoc(eventRef, updatedEvent);

        showToast('Event saved successfully!', "success");

        // Optional: Re-enable the upload button if needed
        document.getElementById('uploadEvent').disabled = false;

        // Optional: Refresh events list or close modal
        fetchEvents();
    } catch (error) {
        console.error("Error saving event:", error);
        showToast("Error saving event. Please try again.", "error");
    }
}

    // Delete Event Function
    async function deleteEvent(eventId) {
        if (confirm('Are you sure you want to delete this event?')) {
            try {
                await deleteDoc(doc(db, 'Events', eventId));
                showToast('Event deleted successfully');
                fetchEvents(); // Refresh event list
            } catch (error) {
                console.error("Error deleting event:", error);
            }
        }
    }
    

    async function addMediaToGallery(category) {
    const [eventId, eventTitle, eventDate, publicStatus, coverPhoto] = eventInfo;
    
    // Get the selected media
    const mediaCollectionRef = collection(db, "Media");
    const mediaQuery = query(mediaCollectionRef, where("eventId", "==", eventId));
    const mediaSnapshot = await getDocs(mediaQuery);
    
    // Get the media details and send to MainGallery
    mediaSnapshot.forEach(async (doc) => {
        const mediaData = doc.data();
        const mediaId = doc.id;
        const { photoUrl, status, price, isPublic, watermarkedImageUrl } = mediaData;

        // Prepare the data to be added to MainGallery
        const mainGalleryData = {
            eventId: eventId,
            mediaId: mediaId,
            category: category, // Portrait, Event, Commercial, Family, Other
            isPublic: isPublic,
            photoUrl: photoUrl,
            status: status,
            watermarkedImageUrl: watermarkedImageUrl,
            price: price,
            appearOnHeader: false
        };

        // Add the media to the MainGallery collection
        await addDoc(collection(db, "MainGallery"), mainGalleryData);

        // Optionally display a success message
        alert('Media successfully added to the gallery!');
    });

    // Close the modal after adding the media
    closeModal();
}



    function openAddToGalleryModal() {
    // Show the modal
    document.getElementById("addToGalleryModal").style.display = "block";
}
function closeModal() {
    // Hide the modal
    document.getElementById("addToGalleryModal").style.display = "none";
}




/**
 * Load media items from MainGallery collection and render them into the gallery container.
 */
 async function loadMainGallery() { 
    const galleryContainer = document.getElementById('galleryContainer');
    galleryContainer.innerHTML = ''; // Clear previous content

    try {
        const mainGalleryRef = collection(db, "MainGallery");
        const mainGallerySnapshot = await getDocs(mainGalleryRef,  where("status", "==", 'active'));

        if (mainGallerySnapshot.empty) {
            galleryContainer.innerHTML = "<p>No media in gallery.</p>";
            return;
        }

        mainGallerySnapshot.forEach(doc => {
            const mediaData = doc.data();
            const mediaId = doc.id;
            const { photoUrl, category, price, status, isPublic, watermarkedImageUrl, appearOn = {} } = mediaData;

            // Ensure appearOn has default values if it's missing
            const defaultAppearOn = {
                HomePage: false,
                AboutPage: false,
                EventPage: false,
                ContactPage: false,
                MainGallery: false
            };

            // Merge appearOn with default values
            const appearOnData = { ...defaultAppearOn, ...appearOn };

            // Create media item card
            const mediaDiv = document.createElement('div');
            mediaDiv.classList.add('media-item');
            mediaDiv.innerHTML = `
                <div class="media-header">
                    <button onclick="toggleCollapse('${mediaId}')">Toggle Details</button>
                    <h4>${category}</h4>
                </div>
                <div id="details-${mediaId}" class="media-details collapse">
                    <img src="${photoUrl}" alt="Media Image" class="media-thumbnail">
                    <p>Price: $${price}</p>
                    <p>Status: ${status}</p>
                    <p>Public: ${isPublic ? "Yes" : "No"}</p>
                    <p><img src="${watermarkedImageUrl}" alt="Watermarked Image" class="media-thumbnail"></p>
                    <div class="media-actions">
                        <div class="appearOn">
                            <h3>Update AppearOn Settings</h3>
                            <div id="checkboxes-${mediaId}" class="checkbox-group">
                                ${renderCheckboxes(['HomePage', 'AboutPage', 'EventPage', 'ContactPage', 'MainGallery'], appearOnData)}
                            </div>
                            <button onclick="handleUpdate('${mediaId}')">Update AppearOn</button>
                        </div>
                        <button onclick="removeMedia('${mediaId}')">Remove</button>
                    </div>
                </div>
            `;

            galleryContainer.appendChild(mediaDiv);
        });
    } catch (error) {
        console.error('Error loading gallery:', error);
        galleryContainer.innerHTML = "<p>Error loading gallery. Please try again later.</p>";
    }
}

/**
 * Render checkboxes for the appearOn settings and set their checked state based on the provided appearOn data.
 * @param {Array<string>} options - Array of checkbox labels/values.
 * @param {Object} appearOn - An object indicating which pages the media should appear on (true or false for each page).
 * @returns {string} - HTML string for the checkbox inputs, with checked checkboxes where applicable.
 */
function renderCheckboxes(options, appearOn) {
    return options
        .map(option => {
            const checked = appearOn[option] ? 'checked' : '';  // Check if the option is true in appearOn
            return `
                <div>
                    <input type="checkbox" id="${option}" value="${option}" ${checked}>
                    <label for="${option}">${option}</label>
                </div>
            `;
        })
        .join('');
}

/**
 * Handle updating the appearOn field for a media item.
 * @param {string} mediaId - The ID of the media document to update.
 */
function handleUpdate(mediaId) {
    const checkboxes = document.querySelectorAll(`#checkboxes-${mediaId} input[type="checkbox"]`);
    const selectedPages = Array.from(checkboxes)
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);

    updateAppearOn(mediaId, selectedPages);
}






// Toggle the collapse of media details
function toggleCollapse(mediaId) {
    const details = document.getElementById(`details-${mediaId}`);
    details.classList.toggle('collapse');
}


/**
 * Update the appearOn field for a specific media item in Firestore.
 * @param {string} imageId - The ID of the media document.
 * @param {Array<string>} selectedPages - The selected pages to update the appearOn array.
 */

// Function to update appearOn array in Firestore
async function updateAppearOn(imageId, selectedPages) {
    try {
        const imageDocRef = doc(collection(db, 'MainGallery'), imageId);

        await updateDoc(imageDocRef, { appearOn: selectedPages });

        showToast(`Successfully updated appearOn for media ID: ${imageId}`, 'success');
    } catch (error) {
        console.error('Error updating appearOn array:', error);
        showToast(`Error updating appearOn for media ID: ${imageId}`, 'error');
    }
}

// Remove Media Function
async function removeMedia(mediaId) {
    const confirmDelete = confirm("Are you sure you want to remove this media from the gallery?");
    if (confirmDelete) {
        // Remove from MainGallery collection
        await deleteDoc(doc(db, "MainGallery", mediaId));
        alert('Media successfully removed from the gallery!');
        loadMainGallery(); // Refresh the gallery list
    }
}

function addMedia(eventID){
    document.getElementsByName("currentEventID").innerText = eventID;
}


    document.addEventListener('DOMContentLoaded', () => {
       
        fetchEvents(); 

loadMainGallery();

        
        window.addMediaToGallery = addMediaToGallery;

        window.openAddToGalleryModal = openAddToGalleryModal;
        window.closeModal = closeModal;

        window.applyWatermark = applyWatermark;
        window.editEvent = editEvent;

        window.uploadEvent = uploadEvent;

        window.fetchEvents = fetchEvents;
        window.viewMedia = viewMedia;

        window.deleteEvent = deleteEvent;
        window.saveEvent = saveEvent;
        window.toggleDetails  = toggleDetails ;

window.loadMainGallery = loadMainGallery;

window.viewAnalytics = viewAnalytics;
window.addMedia = addMedia;
window.toggleCollapse  = toggleCollapse;
window.showTabContent = showTabContent;
window.updateAppearOn = updateAppearOn;
window.removeMedia = removeMedia;

window.handleFileUpload = handleFileUpload;
window.updatePreview = updatePreview;

window.renderCheckboxes = renderCheckboxes;

 

        const saveEventBTN = document.getElementById('saveEvent');
    if (saveEvent) {
        saveEventBTN.addEventListener('click', saveEventBTN);
    }

    // Listener for the "Upload Event" button
    const uploadEventButton = document.getElementById('uploadEvent');
    if (uploadEventButton) {
        uploadEventButton.addEventListener('click', uploadEvent);
    }


    // Listener for the "Sort by" dropdown
    const sortByDropdown = document.getElementById('sortBy');
    if (sortByDropdown) {
        sortByDropdown.addEventListener('change', fetchEvents);
    }



// Function to show content for a selected tab
function showTabContent(tabId) {
    // Hide all tab content
    const allTabs = document.querySelectorAll('.media_tabs');
    allTabs.forEach((tab) => {
        tab.style.display = 'none';
    });

    // Remove 'active' class from all buttons
    const allButtons = document.querySelectorAll('.tabButton');
    allButtons.forEach((button) => {
        button.classList.remove('active');
    });

    // Show the selected tab content and activate the button
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        selectedTab.style.display = 'block';
        const activeButton = document.querySelector(`.tabButton[onclick="showTabContent('${tabId}')"]`);
        if (activeButton) activeButton.classList.add('active');

        // Save the selected tab to local storage
        localStorage.setItem('activeTab', tabId);
    }
}

// Function to load the last selected tab on page load
function loadLastTab() {
    // Retrieve the last active tab from local storage
    const savedTab = localStorage.getItem('activeTab');

    // Show the saved tab if it exists, otherwise show the default tab
    if (savedTab) {
        showTabContent(savedTab);
    } else {
        showTabContent('Add_Event'); // Default tab
    }
}

// Run on page load
document.addEventListener('DOMContentLoaded', loadLastTab);
});

</script>

</body>
</html>
