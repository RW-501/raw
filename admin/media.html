<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event & Photo Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">


    <link rel="stylesheet" href="../css/admin.css">

</head>
<body>


<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <a class="navbar-brand" href="../admin/index">ShutterWorx Admin</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="../admin/analytics">Analytics</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/contact">Contact</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/design">Design</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/index">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/media">Media</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/transactions">Transactions</a>
            </li>
        </ul>
    </div>
</nav>


<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="../admin/">Home</a></li>
      <li class="breadcrumb-item active" aria-current="page">Media</li>
    </ol>
  </nav>
  


  <main id="main-content">


    <div class="container mt-5">
        <h2 class="text-center mb-4">Event & Photo Management</h2>
    
        <!-- Admin Messages Section -->
        <section>
            <div id="admin-messages" class="admin-messages-container">
                <p id="message-text" class="fade-in"></p>
                <div id="message-actions" class="message-actions"></div>
            </div>
        </section>
    
        <!-- Event Upload Form -->
        <div class="card mb-4 shadow-lg">
            <div class="card-body">
                <h5 class="card-title">Upload New Event</h5>
                <form id="eventForm">
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Event Title</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="eventDate" class="form-label">Event Date</label>
                        <input type="date" class="form-control" id="eventDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventCover" class="form-label">Cover Photo</label>
                        <input type="file" class="form-control" id="eventCover" accept="image/*" required>
                    </div>
                    <div class="mb-3">
                        <label for="accessCode" class="form-label">Access Code (if private)</label>
                        <input type="text" class="form-control" id="accessCode" placeholder="Optional">
                    </div>
                    <button id="uploadEvent" type="button" class="btn btn-primary" onclick="uploadEvent()">Upload Event</button>
                </form>
            </div>
        </div>
    
        <!-- Bulk Photo Upload Section -->
        <div class="card mb-4 shadow-lg">
            <div class="card-body">
                <h5 class="card-title">Upload Photos for Events</h5>
                <input type="file" id="photoUpload" class="form-control" multiple accept="image/*">
                <div class="mt-3">
                    <label for="watermarkText" class="form-label">Watermark Text</label>
                    <input type="text" class="form-control" id="watermarkText" placeholder="Enter watermark text">
                </div>
                <div class="mt-3">
                    <label for="watermarkPosition" class="form-label">Watermark Position</label>
                    <select class="form-control" id="watermarkPosition">
                        <option value="center">Centered</option>
                        <option value="diagonal">Diagonal</option>
                    </select>
                </div>
                <div class="mt-3">
                    <label for="watermarkOpacity" class="form-label">Watermark Opacity</label>
                    <input type="range" class="form-control" id="watermarkOpacity" min="0" max="1" step="0.1" value="0.5">
                </div>
                <div class="mt-3">
                    <label for="logoOverlay" class="form-label">Logo Overlay (Optional)</label>
                    <input type="file" class="form-control" id="logoOverlay" accept="image/*">
                </div>
                <div class="mt-3">
                    <label for="logoScale" class="form-label">Logo Scale (Resize)</label>
                    <input type="range" class="form-control" id="logoScale" min="0.1" max="1" step="0.1" value="0.5">
                </div>
                <div class="mt-3">
                    <label for="photoPrice" class="form-label">Photo Price</label>
                    <input type="number" class="form-control" id="photoPrice" placeholder="Set price for this photo (optional)">
                </div>
                <div class="mt-3">
                    <label for="photoPublic" class="form-label">Make Photo Public</label>
                    <input type="checkbox" id="photoPublic" class="form-check-input">
                </div>
                <div class="mt-3">
                    <label for="collectionPrice" class="form-label">Collection Price</label>
                    <input type="number" class="form-control" id="collectionPrice" placeholder="Set price for the entire collection (optional)">
                </div>
                <button id="bulkUploadPhotos" type="button" class="btn btn-primary mt-3" onclick="bulkUploadPhotos()">Upload Photos with Watermark</button>
            </div>
        </div>
    
        <!-- Event List with Edit & Delete Options -->
        <div id="eventList" class="mb-4">
            <h5 class="mb-3">Manage Events</h5>
            <div class="list-group" id="eventsContainer"></div>
        </div>
    </div>

  </main>
  <!-- Footer -->
<footer class="bg-dark text-light py-3">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <p>&copy; 2024 <a href="https://ShutterWorx.co" class="text-light">ShutterWorx</a> All rights reserved.</p>
            </div>
            <div class="col-md-6 text-md-right">
                <ul class="list-inline">
                    <li class="list-inline-item"><a href="https://ShutterWorx.co/FAQ" class="text-light">FAQs</a></li>
                    <li class="list-inline-item"><a href="https://ShutterWorx.co/join" class="text-light">Upgrade</a></li>
                    <li class="list-inline-item"><a href="https://ShutterWorx.co/contact" class="text-light">Contact Us</a></li>
                    <li class="list-inline-item"><a href="https://ShutterWorx.co/privacy" class="text-light">Privacy Policy</a></li>
                    <li class="list-inline-item"><a href="https://ShutterWorx.co/terms" class="text-light">Terms of Service</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>

<script src="../js/main.js" ></script>
<script src="../js/admin.js" ></script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>


<!-- Firebase JS SDK and Custom Scripts -->

<script type="module">
    import { db, doc, getDoc, query, updateDoc, 
            setDoc, ref, signInWithPopup, 
            GoogleAuthProvider, FacebookAuthProvider, 
            uploadBytes, OAuthProvider, arrayUnion, 
            signOut, addDoc, increment, onAuthStateChanged, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword, 
            where, getDocs, storage, collection, 
            auth, analytics, deleteDoc, getDownloadURL } from '../js/module.js';

    // Bulk Upload Photos Function
    async function bulkUploadPhotos() {
        const watermarkText = document.getElementById('watermarkText').value;
        const watermarkPosition = document.getElementById('watermarkPosition').value;
        const watermarkOpacity = document.getElementById('watermarkOpacity').value;
        const logoOverlay = document.getElementById('logoOverlay').files[0];
        const logoScale = document.getElementById('logoScale').value;
        const photos = document.getElementById('photoUpload').files;
        const photoPrice = document.getElementById('photoPrice').value;
        const collectionPrice = document.getElementById('collectionPrice').value;
        const isPublic = document.getElementById('photoPublic').checked;

        // Check if photos are uploaded
        if (photos.length === 0) {
            alert("Please select at least one photo.");
            return;
        }

        // Process each photo
        for (const photo of photos) {
            const photoRef = ref(storage, `events/photos/${photo.name}`);
            try {
                // Upload photo to Firebase storage
                await uploadBytes(photoRef, photo);
                const photoUrl = await getDownloadURL(photoRef);

                // Process watermarking
                let watermarkedImageUrl = await applyWatermark(photoUrl, watermarkText, watermarkPosition, watermarkOpacity, logoOverlay, logoScale);

                // Store watermarked image URL or use as needed
                console.log('Watermarked image URL:', watermarkedImageUrl);

                // Save photo details (Price, Public status)
                await savePhotoDetails(photoUrl, photoPrice, collectionPrice, isPublic);

            } catch (error) {
                console.error("Error uploading photo:", error);
                alert("An error occurred while uploading the photo.");
            }
        }
    }

    // Save Photo Details (Price and Public status)
    async function savePhotoDetails(photoUrl, photoPrice, collectionPrice, isPublic) {
        const photoDetails = {
            photoUrl,
            price: photoPrice,
            collectionPrice,
            isPublic,
            timestamp: new Date()
        };

        try {
            const docRef = await addDoc(collection(db, "photos"), photoDetails);
            console.log("Document written with ID: ", docRef.id);
        } catch (error) {
            console.error("Error adding document: ", error);
        }
    }

    async function applyWatermark(imageUrl, text, position, opacity, logo, scale) {
        // Here we should use a canvas or image processing library to apply the watermark
        // This is just a simple illustration:

        const img = new Image();
        img.src = imageUrl;

        await new Promise((resolve) => {
            img.onload = resolve;
        });

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = img.width;
        canvas.height = img.height;

        ctx.drawImage(img, 0, 0);

        // Apply text watermark
        if (text) {
            ctx.font = "30px Arial";
            ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
            if (position === "center") {
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(text, img.width / 2, img.height / 2);
            } else if (position === "diagonal") {
                ctx.save();
                ctx.translate(img.width / 2, img.height / 2);
                ctx.rotate(Math.PI / 4); // 45 degrees
                ctx.fillText(text, 0, 0);
                ctx.restore();
            }
        }

        // Apply logo watermark (if any)
        if (logo) {
            const logoImg = new Image();
            logoImg.src = URL.createObjectURL(logo);
            await new Promise((resolve) => {
                logoImg.onload = resolve;
            });

            const logoWidth = logoImg.width * scale;
            const logoHeight = logoImg.height * scale;
            const x = img.width - logoWidth - 10;
            const y = img.height - logoHeight - 10;

            ctx.drawImage(logoImg, x, y, logoWidth, logoHeight);
        }

        return canvas.toDataURL();
    }

    // Function to upload event details
function uploadEvent() {
    const eventTitle = document.getElementById('eventTitle').value;
    const eventDescription = document.getElementById('eventDescription').value;
    const eventDate = document.getElementById('eventDate').value;
    const eventCover = document.getElementById('eventCover').files[0];
    const accessCode = document.getElementById('accessCode').value;

    if (!eventTitle || !eventDescription || !eventDate || !eventCover) {
        alert("Please fill in all required fields.");
        return;
    }

    // Proceed with uploading event (this is an example, you should add your logic)
    const eventDetails = {
        title: eventTitle,
        description: eventDescription,
        date: eventDate,
        cover: eventCover,
        accessCode: accessCode || null, // Optional
    };

    console.log("Event to upload:", eventDetails);

    // You can now use Firebase, for example, to save the event.
}

</script>

</body>
</html>
