<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Analytics - Photographer's Dashboard</title>

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">


        <link rel="stylesheet" href="../css/admin.css">
  
    <style>
        .loading {
            display: none;
        }

        .card-body {
            background-color: #f8f9fa;
        }

        .display-4 {
            font-size: 2rem;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .analytics-card {
            transition: transform 0.3s;
        }

        .analytics-card:hover {
            transform: scale(1.05);
        }

        .error-message {
            color: red;
            font-weight: bold;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-left: auto;
            margin-right: auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

</head>
<body>



<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <a class="navbar-brand" href="https://shutterworx.co/">ShutterWorx </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="../">Your Site</a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="../admin/">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/media">Media</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/contact">Contact</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/design">Design</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/analytics">Analytics</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/transactions">Transactions</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../admin/settings">Settings</a>
            </li>
        </ul>
    </div>
</nav>


<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="../admin/">Home</a></li>
      <li class="breadcrumb-item active" aria-current="page">Analytics</li>
    </ol>
  </nav>
  



        <main id="main-content">
        <section>
            <div class="container mt-5">
                <h2 class="text-center mb-4">Website Analytics Dashboard</h2>
                <section>
                    <div id="admin-messages" class="admin-messages-container">
                        <p id="message-text" class="fade-in"></p>
                        <div id="message-actions" class="message-actions"></div>
                    </div>
                </section>
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card analytics-card shadow-sm">
                            <div class="card-body">
                                <h5 class="section-title">Page Views</h5>
                                <p id="pageViews" class="display-4">Loading...</p>
                                <div class="loading-spinner loading" id="loadingPageViews"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card analytics-card shadow-sm">
                            <div class="card-body">
                                <h5 class="section-title">Total Duration</h5>
                                <p id="totalDuration" class="display-4">Loading...</p>
                                <div class="loading-spinner loading" id="loadingImageDownloads"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card analytics-card shadow-sm">
                            <div class="card-body">
                                <h5 class="section-title">Total Users:</h5>
                                <p id="usersDisplay" class="display-4">Loading...</p>
                                <div class="loading-spinner loading" id="loadingEventPurchases"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card analytics-card shadow-sm">
                            <div class="card-body">
                                <h5 class="section-title">User Engagement</h5>
                                <p id="userEngagement" class="display-4">Loading...</p>
                                <div class="loading-spinner loading" id="loadingUserEngagement"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Add more event-specific or general analytics as needed -->
            </div>
        </section>
<section>
            <title>User Analytics</title>
            <style>
              body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f4f4f9;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
              }
              th, td {
                padding: 12px;
                text-align: left;
                border: 1px solid #ddd;
              }
              th {
                background-color: #4CAF50;
                color: white;
              }
              tr:nth-child(even) {
                background-color: #f2f2f2;
              }

              section {
                margin: 3rem;
              }
            </style>
       
       
            <h1>User Analytics</h1>
            <div id="userAnalyticsTableContainer">
              <!-- The table will be injected here -->
            </div>
        </section>
        <section>

            <title>Event Analytics</title>
            <style>
              body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f4f4f9;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
              }
              th, td {
                padding: 12px;
                text-align: left;
                border: 1px solid #ddd;
              }
              th {
                background-color: #4CAF50;
                color: white;
              }
              tr:nth-child(even) {
                background-color: #f2f2f2;
              }
            </style>
          </head>
          <body>
            <h1>Event Analytics</h1>
            <div id="eventTableContainer">
              <!-- The table will be injected here -->
            </div>
          

        </section>










        <div class="error-message" id="errorMessage"></div>
    </main>



        
<!-- Footer -->
<footer class="bg-dark text-light py-3">
  <div class="container">
      <div class="row">
          <div class="col-md-6">
              <p>&copy; 2024 <a href="https://ShutterWorx.co" class="text-light">ShutterWorx</a> All rights reserved.</p>
          </div>
          <div class="col-md-6 text-md-right">
              <ul class="list-inline">
                  <li class="list-inline-item"><a href="https://ShutterWorx.co/FAQ" class="text-light">FAQs</a></li>
                  <li class="list-inline-item"><a href="https://ShutterWorx.co/join" class="text-light">Upgrade</a></li>
                  <li class="list-inline-item"><a href="https://ShutterWorx.co/contact" class="text-light">Contact Us</a></li>
                  <li class="list-inline-item"><a href="https://ShutterWorx.co/privacy" class="text-light">Privacy Policy</a></li>
                  <li class="list-inline-item"><a href="https://ShutterWorx.co/terms" class="text-light">Terms of Service</a></li>
              </ul>
          </div>
      </div>
  </div>
</footer>



<script src="../js/admin.js" ></script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase JS SDK and Custom Scripts -->
    <script type="module">
        import {  db,getStorage, ref, uploadBytes, getDownloadURL,
    doc,arrayUnion, RecaptchaVerifier ,increment, getDoc   ,signInWithPhoneNumber,
     query, updateDoc , setDoc, addDoc,signInAnonymously , orderBy,
      signInWithPopup,FacebookAuthProvider, GoogleAuthProvider,startAfter ,
       OAuthProvider, signOut, onAuthStateChanged, deleteDoc, getFirestore,
        createUserWithEmailAndPassword, signInWithEmailAndPassword, deleteObject,
         where, getDocs, storage, getAuth, collection, auth, analytics } from '../js/module.js';
    
       
         // Function to show loading spinner
        function showLoading(metric) {
            document.getElementById('loading' + metric.charAt(0).toUpperCase() + metric.slice(1)).style.display = 'inline-block';
            document.getElementById(metric).style.display = 'none';
        }
    
        // Function to hide loading spinner
        function hideLoading(metric) {
          //  document.getElementById('loading' + metric.charAt(0).toUpperCase() + metric.slice(1)).style.display = 'none';
            document.getElementById(metric).style.display = 'block';
        }
    
        // Function to display error message
        function displayError(message) {
            document.getElementById('errorMessage').textContent = message;
        }
    






/**
 * Helper function to format date and time based on specified options
 * @param {string} dateString - The date string to format
 * @param {Object} options - Formatting options
 * @returns {string} - Formatted date and time
 */
 function formatDate(dateString, options = {}) {
  const date = new Date(dateString);

  // Default formatting options
  const defaultOptions = {
    weekday: "long", // "Monday"
    year: "numeric", // "2024"
    month: "long", // "November"
    day: "numeric", // "21"
    hour: "numeric", // "12"
    minute: "numeric", // "11"
    second: "numeric", // "26"
    hour12: true // Use 12-hour clock with AM/PM
  };

  // Merge user options with defaults
  const finalOptions = { ...defaultOptions, ...options };

  // Return formatted date
  return date.toLocaleString("en-US", finalOptions);
}

// Function to format the "viewedBy" data into an HTML structure
function formatViewedBy(viewedByData = {}) {
  return `
    <ul>
      <li><strong>Duration of View:</strong> ${viewedByData.durationOfView || 'N/A'} seconds</li>
      <li><strong>Contact Views:</strong> ${viewedByData.contactViews || 'N/A'}</li>
      <li><strong>View Method:</strong> ${viewedByData.viewMethod || 'N/A'}</li>
      <li><strong>View Source:</strong> ${viewedByData.viewSource || 'N/A'}</li>
      <li><strong>View Date:</strong> ${viewedByData.viewDate ? formatDate(viewedByData.viewDate) : 'N/A'}</li>
    </ul>
  `;
}

// Function to toggle visibility of detail rows
function toggleDetailSection(rowId) {
  const detailRow = document.getElementById(`details-${rowId}`);
  if (detailRow) {
    detailRow.style.display = detailRow.style.display === 'none' ? 'table-row' : 'none';
  }
}

// Main function to display user analytics
async function displayUserAnalytics() {
  const analyticsData = await fetchUserAnalyticsData(); // Fetch the data
  const totalUsers = analyticsData.length;

  // Display the total user count
  document.getElementById('usersDisplay').innerHTML = `<h3>Total Users: ${totalUsers}</h3>`;

  // Construct the table structure
  let tableHTML = `
    <table>
      <thead>
        <tr>
          <th>IP Address</th>
          <th>City</th>
          <th>Country</th>
          <th>State</th>
          <th>Last View Date</th>
          <th>Total Duration (Seconds)</th>
          <th>Activities Count</th>
          <th>User Blocked</th>
        </tr>
      </thead>
      <tbody>
  `;

  analyticsData.forEach(user => {
    // Add main row
    tableHTML += `
      <tr>
        <td><button class="collapsible" onclick="toggleDetailSection('${user.ipAddress}')">${user.ipAddress}</button></td>
        <td>${user.city || 'N/A'}</td>
        <td>${user.country || 'N/A'}</td>
        <td>${user.state || 'N/A'}</td>
        <td>${user.lastViewDate ? formatDate(user.lastViewDate) : 'N/A'}</td>
        <td>${user.totalDuration || 0}</td>
        <td>${user.userActivitiesCount || 0}</td>
        <td>${user.userBlocked ? 'Yes' : 'No'}</td>
      </tr>
    `;

    // Add collapsible detail row
    tableHTML += `
      <tr id="details-${user.ipAddress}" class="details-row" style="display: none;">
        <td colspan="8">
          <div class="user-details">
            <h4>Details for ${user.ipAddress}</h4>
            ${formatViewedBy(user.contactViewedBy)}
            ${formatViewedBy(user.eventDetailsViewedBy)}
            ${formatViewedBy(user.homeViewedBy)}
          </div>
        </td>
      </tr>
    `;
  });

  // Close table
  tableHTML += '</tbody></table>';

  // Insert the table into the container
  document.getElementById('userAnalyticsTableContainer').innerHTML = tableHTML;
}

// Fetch user analytics data from Firestore
async function fetchUserAnalyticsData() {
  const analyticsCollection = collection(db, "Analytics"); // Reference to the Analytics collection
  const analyticsSnapshot = await getDocs(analyticsCollection); // Fetch all documents
  const analyticsList = analyticsSnapshot.docs.map(doc => ({
    ipAddress: doc.id, // IP address as doc ID
    city: doc.data().city,
    country: doc.data().country,
    state: doc.data().state,
    totalDuration: doc.data().totalDuration,
    userActivitiesCount: doc.data().userActivitiesCount,
    userBlocked: doc.data().userBlocked || false,
    viewSource: doc.data().viewSource,
    viewMethod: doc.data().viewMethod,
    contactViewedBy: doc.data().contactViewedBy || {},
    eventDetailsViewedBy: doc.data().eventDetailsViewedBy || {},
    homeViewedBy: doc.data().homeViewedBy || {},
    lastViewDate: doc.data().lastViewDate,
  }));
  return analyticsList;
}

// Execute the function on page load
displayUserAnalytics();


// Function to toggle the display of user details based on IP address
function toggleDetailSection(ipAddress) {
  const detailRow = document.getElementById(`details-${ipAddress}`);
  if (detailRow.style.display === "none") {
    detailRow.style.display = "table-row"; // Show the detail section
  } else {
    detailRow.style.display = "none"; // Hide the detail section
  }
}





/*

    contactViewedBy: doc.data().contactViewedBy,
    eventDetailsViewedBy: doc.data().eventDetailsViewedBy,
    homeViewedBy: doc.data().homeViewedBy,
    aboutViewedBy: doc.data().aboutViewedBy,
    confirmationViewedBy: doc.data().confirmationViewedBy,
    eventDetailsViewedBy: doc.data().eventDetailsViewedBy,
    eventsViewedBy: doc.data().eventsViewedBy,
    galleryViewedBy: doc.data().galleryViewedBy,
    homeViewedBy: doc.data().homeViewedBy,*/







async function displayEventAnalytics() {
      const events = await fetchEventsData();

      // Create a table
      let tableHTML = `
        <table>
          <thead>
            <tr>
              <th>Event Title</th>
              <th>Views</th>
            <th>Retrieve Count</th>
              <th>Status</th>
              <th>Public</th>
              <th>Event ID</th>
              <th>Add Date</th>
            </tr>
          </thead>
          <tbody>
      `;

      // Loop through events and create table rows
      events.forEach(event => {
        tableHTML += `
          <tr>
            <td>${event.title}</td>
            <td>${event.views}</td>
            <td>${event.retrieveCount}</td>
            <td>${event.status}</td>
            <td>${event.isPublic}</td>
            <td>${event.id}</td>
            <td>${formatDate(event.timestamp)}</td>
          </tr>
        `;
      });

      tableHTML += '</tbody></table>';

      // Insert the table into the container
      document.getElementById("eventTableContainer").innerHTML = tableHTML;
    }

async function fetchEventsData() {
  const eventsCollection = collection(db, "Events"); // reference to the Events collection
  const eventsSnapshot = await getDocs(eventsCollection); // fetch all documents in the collection
  const eventsList = eventsSnapshot.docs.map(doc => ({
    id: doc.id, // Document ID
    title: doc.data().title, // Title field
    views: doc.data().views, // Views field
    retrieveCount: doc.data().retrieveCount, 
    isPublic: doc.data().isPublic, 
    timestamp: doc.data().timestamp, 
    status: doc.data().status 
    
  }));
  return eventsList;
}









window.toggleDetailSection  = toggleDetailSection ;

       
// Window onload event to fetch data when the page loads
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get("eventId");


console.log("Data ??????????????????????");

            if (eventId) {
              //  fetchEventAnalytics(eventId);  // Fetch data for the specific event
            } else {
              //  fetchAnalyticsData();  // Fetch general analytics data
            }
            // my Analyics
            fetchEventsData();
            fetchUserAnalyticsData();
   // Display user analytics when the page loads
   displayUserAnalytics();
  
    // Display event analytics when the page loads
    displayEventAnalytics();




        };
    
      
        
        // Display trend data on the trend chart
        function displayTrendAnalysis(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Page Views',
                        data: data.pageViews,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Views'
                            }
                        }
                    }
                }
            });
        }
    
    </script>
    

    
</body>

</html>
